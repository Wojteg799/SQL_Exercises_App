{
    "title": "Customer Value Segmentation (Multiple CTEs)",
    "description": "Using multiple CTEs, segment customers into <code>High</code>, <code>Mid</code>, or <code>Low</code> value based on their total spending compared to the average customer spend. Display <code>name</code>, <code>total_spent</code>, and <code>segment</code>.<br><br>Rules: total_spent > 1.5× average → High, total_spent > 0.5× average → Mid, otherwise → Low.",
    "hint": "CTE 1: total spend per customer. CTE 2: average of those totals (scalar). CTE 3 or final SELECT: JOIN customer totals with the average and apply CASE WHEN.",
    "solution": "WITH customer_spend AS (SELECT customers.name, SUM(products.price * order_items.quantity) as total_spent FROM customers INNER JOIN orders ON customers.customer_id = orders.customer_id INNER JOIN order_items ON orders.order_id = order_items.order_id INNER JOIN products ON order_items.product_id = products.product_id GROUP BY customers.customer_id, customers.name), avg_spend AS (SELECT AVG(total_spent) as avg_total FROM customer_spend) SELECT customer_spend.name, ROUND(customer_spend.total_spent, 2) as total_spent, CASE WHEN customer_spend.total_spent > avg_spend.avg_total * 1.5 THEN 'High' WHEN customer_spend.total_spent > avg_spend.avg_total * 0.5 THEN 'Mid' ELSE 'Low' END as segment FROM customer_spend CROSS JOIN avg_spend ORDER BY total_spent DESC"
}